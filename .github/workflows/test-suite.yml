name: ğŸ§ª Test Suite
# æ¸¬è©¦å¥—ä»¶ï¼šé‹è¡Œæ‰€æœ‰æ¸¬è©¦ç¢ºä¿ä»£ç¢¼å“è³ª

on:
  push:
    branches: [main, dev]
    paths:
      - 'petsard/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/test-suite.yml'
  pull_request:
    branches: [main, dev]
    paths:
      - 'petsard/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/test-suite.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    continue-on-error: true  # ä¸å¼·åˆ¶è¦æ±‚æ¸¬è©¦é€šéæ‰èƒ½åˆä½µ
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-
            
      - name: ğŸ”§ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          
      - name: ğŸ§ª Run Unit Tests
        id: unit-tests
        run: |
          echo "## ğŸ§ª æ¸¬è©¦çµæœ Test Results" >> test_report.md
          echo "" >> test_report.md
          echo "**Python ç‰ˆæœ¬**: ${{ matrix.python-version }}" >> test_report.md
          echo "**åŸ·è¡Œæ™‚é–“**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> test_report.md
          echo "" >> test_report.md
          
          # é‹è¡Œæ¸¬è©¦ä¸¦æ•ç²çµæœ
          if pytest tests/ --tb=short -v --disable-warnings > test_output.txt 2>&1; then
            echo "test_status=success" >> $GITHUB_OUTPUT
            echo "### âœ… æ¸¬è©¦é€šé Tests Passed" >> test_report.md
          else
            echo "test_status=failed" >> $GITHUB_OUTPUT
            echo "### âŒ æ¸¬è©¦å¤±æ•— Tests Failed" >> test_report.md
          fi
          
          echo "" >> test_report.md
          echo "```" >> test_report.md
          cat test_output.txt >> test_report.md
          echo "```" >> test_report.md
          
      - name: ğŸ§ª Run Functional Tests
        id: functional-tests
        run: |
          echo "" >> test_report.md
          echo "### ğŸ”„ åŠŸèƒ½æ¸¬è©¦ Functional Tests" >> test_report.md
          echo "" >> test_report.md
          
          if pytest tests/test_petsard.py -v --disable-warnings > functional_output.txt 2>&1; then
            echo "functional_status=success" >> $GITHUB_OUTPUT
            echo "âœ… **åŠŸèƒ½æ¸¬è©¦é€šé** Functional tests passed" >> test_report.md
          else
            echo "functional_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ **åŠŸèƒ½æ¸¬è©¦å¤±æ•—** Functional tests failed" >> test_report.md
          fi
          
          echo "" >> test_report.md
          echo "```" >> test_report.md
          cat functional_output.txt >> test_report.md
          echo "```" >> test_report.md
          
      - name: ğŸ“Š Generate Test Summary
        run: |
          echo "" >> test_report.md
          echo "### ğŸ“Š æ¸¬è©¦æ‘˜è¦ Test Summary" >> test_report.md
          echo "" >> test_report.md
          
          if [[ "${{ steps.unit-tests.outputs.test_status }}" == "success" && "${{ steps.functional-tests.outputs.functional_status }}" == "success" ]]; then
            echo "ğŸ‰ **æ‰€æœ‰æ¸¬è©¦é€šéï¼** All tests passed!" >> test_report.md
            echo "test_overall=success" >> $GITHUB_ENV
          else
            echo "âš ï¸ **éƒ¨åˆ†æ¸¬è©¦å¤±æ•—** Some tests failed" >> test_report.md
            echo "test_overall=failed" >> $GITHUB_ENV
          fi
          
          echo "" >> test_report.md
          echo "---" >> test_report.md
          echo "*æ­¤å ±å‘Šç”±æ¸¬è©¦å¥—ä»¶è‡ªå‹•ç”Ÿæˆ | Auto-generated by Test Suite*" >> test_report.md
          
      - name: ğŸ’¬ Comment Test Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('test_report.md', 'utf8');
            
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰æ¸¬è©¦çµæœç•™è¨€
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ§ª æ¸¬è©¦çµæœ Test Results')
            );
            
            const commentBody = `## ğŸ§ª æ¸¬è©¦å¥—ä»¶å ±å‘Š Test Suite Report\n\n${report}`;
            
            if (botComment) {
              // æ›´æ–°ç¾æœ‰ç•™è¨€
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // å‰µå»ºæ–°ç•™è¨€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
            
      - name: ğŸ“¤ Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-python-${{ matrix.python-version }}
          path: |
            test_output.txt
            functional_output.txt
            test_report.md
          retention-days: 7
          
      - name: â„¹ï¸ Test Status Summary
        if: always()
        run: |
          if [[ "$test_overall" == "success" ]]; then
            echo "::notice::ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼All tests passed for Python ${{ matrix.python-version }}"
          else
            echo "::warning::âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œä½†ä¸æœƒé˜»æ­¢åˆä½µã€‚Some tests failed for Python ${{ matrix.python-version }}, but merge is not blocked."
          fi