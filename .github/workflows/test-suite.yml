name: ğŸ§ª Test Suite
# æ¸¬è©¦å¥—ä»¶ï¼šé‹è¡Œæ‰€æœ‰æ¸¬è©¦ç¢ºä¿ä»£ç¢¼å“è³ª

on:
  push:
    branches: [main, dev]
    paths:
      - 'petsard/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/test-suite.yml'
  pull_request:
    branches: [main, dev]
    paths:
      - 'petsard/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/test-suite.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    continue-on-error: true  # ä¸å¼·åˆ¶è¦æ±‚æ¸¬è©¦é€šéæ‰èƒ½åˆä½µ
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-
            
      - name: ğŸ”§ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          
      - name: ğŸ” Run Ruff Code Quality Check
        id: ruff-check
        run: |
          echo "## ğŸ” ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ Code Quality Check" >> ruff_report.md
          echo "" >> ruff_report.md
          echo "**Python ç‰ˆæœ¬**: ${{ matrix.python-version }}" >> ruff_report.md
          echo "**åŸ·è¡Œæ™‚é–“**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ruff_report.md
          echo "" >> ruff_report.md
          
          # é‹è¡Œ Ruff æª¢æŸ¥ä¸¦æ•ç²çµæœ
          if ruff check . --output-format=text > ruff_output.txt 2>&1; then
            echo "ruff_status=success" >> $GITHUB_OUTPUT
            echo "### âœ… ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥é€šé Code Quality Check Passed" >> ruff_report.md
            echo "" >> ruff_report.md
            echo "ğŸ‰ **æ‰€æœ‰ç¨‹å¼ç¢¼éƒ½ç¬¦åˆå“è³ªæ¨™æº–ï¼** All code meets quality standards!" >> ruff_report.md
            echo "" >> ruff_report.md
            echo "**æª¢æŸ¥é …ç›® Checked Rules:**" >> ruff_report.md
            echo "- âœ… **E**: pycodestyle errors (ç¨‹å¼ç¢¼é¢¨æ ¼éŒ¯èª¤)" >> ruff_report.md
            echo "- âœ… **W**: pycodestyle warnings (ç¨‹å¼ç¢¼é¢¨æ ¼è­¦å‘Š)" >> ruff_report.md
            echo "- âœ… **F**: pyflakes (æœªä½¿ç”¨çš„å°å…¥ã€è®Šæ•¸ç­‰)" >> ruff_report.md
            echo "- âœ… **I**: isort (å°å…¥æ’åº)" >> ruff_report.md
            echo "- âœ… **B**: flake8-bugbear (å¸¸è¦‹éŒ¯èª¤æ¨¡å¼)" >> ruff_report.md
            echo "- âœ… **C4**: flake8-comprehensions (åˆ—è¡¨æ¨å°å¼å„ªåŒ–)" >> ruff_report.md
            echo "- âœ… **UP**: pyupgrade (Python èªæ³•ç¾ä»£åŒ–)" >> ruff_report.md
          else
            echo "ruff_status=failed" >> $GITHUB_OUTPUT
            echo "### âŒ ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å¤±æ•— Code Quality Check Failed" >> ruff_report.md
            echo "" >> ruff_report.md
            
            # åˆ†æéŒ¯èª¤ä¸¦åˆ†é¡
            echo "#### ğŸ” è©³ç´°éŒ¯èª¤åˆ†æ Detailed Error Analysis" >> ruff_report.md
            echo "" >> ruff_report.md
            
            # çµ±è¨ˆå„é¡éŒ¯èª¤æ•¸é‡
            E_COUNT=$(grep -c "^[^:]*:[^:]*:[^:]*: E" ruff_output.txt 2>/dev/null || echo "0")
            W_COUNT=$(grep -c "^[^:]*:[^:]*:[^:]*: W" ruff_output.txt 2>/dev/null || echo "0")
            F_COUNT=$(grep -c "^[^:]*:[^:]*:[^:]*: F" ruff_output.txt 2>/dev/null || echo "0")
            I_COUNT=$(grep -c "^[^:]*:[^:]*:[^:]*: I" ruff_output.txt 2>/dev/null || echo "0")
            B_COUNT=$(grep -c "^[^:]*:[^:]*:[^:]*: B" ruff_output.txt 2>/dev/null || echo "0")
            C4_COUNT=$(grep -c "^[^:]*:[^:]*:[^:]*: C4" ruff_output.txt 2>/dev/null || echo "0")
            UP_COUNT=$(grep -c "^[^:]*:[^:]*:[^:]*: UP" ruff_output.txt 2>/dev/null || echo "0")
            
            echo "**éŒ¯èª¤çµ±è¨ˆ Error Statistics:**" >> ruff_report.md
            echo "- ğŸ”´ **E (pycodestyle errors)**: $E_COUNT å€‹éŒ¯èª¤" >> ruff_report.md
            echo "- ğŸŸ¡ **W (pycodestyle warnings)**: $W_COUNT å€‹è­¦å‘Š" >> ruff_report.md
            echo "- ğŸ”µ **F (pyflakes)**: $F_COUNT å€‹å•é¡Œ" >> ruff_report.md
            echo "- ğŸŸ£ **I (isort)**: $I_COUNT å€‹å°å…¥å•é¡Œ" >> ruff_report.md
            echo "- ğŸŸ  **B (bugbear)**: $B_COUNT å€‹æ½›åœ¨éŒ¯èª¤" >> ruff_report.md
            echo "- ğŸŸ¢ **C4 (comprehensions)**: $C4_COUNT å€‹å„ªåŒ–å»ºè­°" >> ruff_report.md
            echo "- ğŸ”¶ **UP (pyupgrade)**: $UP_COUNT å€‹èªæ³•ç¾ä»£åŒ–å»ºè­°" >> ruff_report.md
            echo "" >> ruff_report.md
            
            # æŒ‰é¡åˆ¥é¡¯ç¤ºå…·é«”éŒ¯èª¤
            for rule_type in E W F I B C4 UP; do
              if grep -q "^[^:]*:[^:]*:[^:]*: $rule_type" ruff_output.txt 2>/dev/null; then
                echo "#### ğŸ“‹ $rule_type é¡åˆ¥éŒ¯èª¤è©³æƒ… $rule_type Category Details" >> ruff_report.md
                echo "" >> ruff_report.md
                echo "```" >> ruff_report.md
                grep "^[^:]*:[^:]*:[^:]*: $rule_type" ruff_output.txt | head -20 >> ruff_report.md
                echo "```" >> ruff_report.md
                echo "" >> ruff_report.md
              fi
            done
            
            # å¦‚æœéŒ¯èª¤å¤ªå¤šï¼Œæä¾›å®Œæ•´è¼¸å‡º
            TOTAL_ERRORS=$(wc -l < ruff_output.txt)
            if [ "$TOTAL_ERRORS" -gt 50 ]; then
              echo "âš ï¸ **æ³¨æ„**: ç™¼ç¾ $TOTAL_ERRORS å€‹å•é¡Œï¼Œä»¥ä¸Šåƒ…é¡¯ç¤ºéƒ¨åˆ†å…§å®¹ã€‚å®Œæ•´å ±å‘Šè«‹æŸ¥çœ‹ä¸‹æ–¹è©³ç´°è¼¸å‡ºã€‚" >> ruff_report.md
              echo "" >> ruff_report.md
            fi
          fi
          
          # æ·»åŠ  Ruff é…ç½®ä¿¡æ¯
          echo "### âš™ï¸ Ruff é…ç½®ä¿¡æ¯ Ruff Configuration" >> ruff_report.md
          echo "" >> ruff_report.md
          echo "**é…ç½®ä¾†æº**: \`pyproject.toml\`" >> ruff_report.md
          echo "**è¡Œé•·åº¦é™åˆ¶**: 88 å­—ç¬¦" >> ruff_report.md
          echo "**ç›®æ¨™ Python ç‰ˆæœ¬**: 3.11" >> ruff_report.md
          echo "**å¿½ç•¥è¦å‰‡**: E501 (è¡Œé•·åº¦ï¼Œå·²ç”± line-length è™•ç†)" >> ruff_report.md
          echo "" >> ruff_report.md
          
          # å®Œæ•´è¼¸å‡º
          echo "### ğŸ“ å®Œæ•´ Ruff è¼¸å‡º Full Ruff Output" >> ruff_report.md
          echo "" >> ruff_report.md
          echo "<details>" >> ruff_report.md
          echo "<summary>é»æ“ŠæŸ¥çœ‹å®Œæ•´ Ruff æª¢æŸ¥è¼¸å‡º Click to view full Ruff output</summary>" >> ruff_report.md
          echo "" >> ruff_report.md
          echo "```" >> ruff_report.md
          cat ruff_output.txt >> ruff_report.md
          echo "```" >> ruff_report.md
          echo "</details>" >> ruff_report.md
          echo "" >> ruff_report.md
          
      - name: ğŸ§ª Run Unit Tests with Coverage
        id: unit-tests
        run: |
          echo "## ğŸ§ª æ¸¬è©¦çµæœ Test Results" >> test_report.md
          echo "" >> test_report.md
          echo "**Python ç‰ˆæœ¬**: ${{ matrix.python-version }}" >> test_report.md
          echo "**åŸ·è¡Œæ™‚é–“**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> test_report.md
          echo "" >> test_report.md
          
          # é‹è¡Œæ¸¬è©¦ä¸¦æ•ç²çµæœï¼ŒåŒ…å«è¦†è“‹ç‡
          if pytest tests/ --cov=petsard --cov-report=term-missing --cov-report=xml --tb=long -v --disable-warnings > test_output.txt 2>&1; then
            echo "test_status=success" >> $GITHUB_OUTPUT
            echo "### âœ… æ¸¬è©¦é€šé Tests Passed" >> test_report.md
          else
            echo "test_status=failed" >> $GITHUB_OUTPUT
            echo "### âŒ æ¸¬è©¦å¤±æ•— Tests Failed" >> test_report.md
            
            # æå–å¤±æ•—çš„æ¸¬è©¦è©³ç´°ä¿¡æ¯
            echo "" >> test_report.md
            echo "#### ğŸ” å¤±æ•—æ¸¬è©¦è©³ç´°ä¿¡æ¯ Failed Test Details" >> test_report.md
            echo "" >> test_report.md
            
            # æå– FAILURES éƒ¨åˆ†
            if grep -A 50 "FAILURES" test_output.txt > failures.txt 2>/dev/null; then
              echo "**å¤±æ•—çš„æ¸¬è©¦æ¡ˆä¾‹ Failed Test Cases:**" >> test_report.md
              echo "" >> test_report.md
              echo "```" >> test_report.md
              head -100 failures.txt >> test_report.md
              echo "```" >> test_report.md
              echo "" >> test_report.md
            fi
            
            # æå– short test summary
            if grep -A 20 "short test summary" test_output.txt > summary.txt 2>/dev/null; then
              echo "**æ¸¬è©¦æ‘˜è¦ Test Summary:**" >> test_report.md
              echo "" >> test_report.md
              echo "```" >> test_report.md
              cat summary.txt >> test_report.md
              echo "```" >> test_report.md
              echo "" >> test_report.md
            fi
          fi
          
      - name: ğŸ“Š Generate Coverage Report
        if: always()
        run: |
          echo "" >> test_report.md
          echo "### ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡ Test Coverage" >> test_report.md
          echo "" >> test_report.md
          
          # ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
          if [ -f coverage.xml ]; then
            # ç°¡åŒ–çš„è¦†è“‹ç‡æå–
            COVERAGE_PERCENT=$(grep -o 'line-rate="[0-9.]*"' coverage.xml | head -1 | grep -o '[0-9.]*' | awk '{printf "%.1f%%", $1*100}')
            if [ -z "$COVERAGE_PERCENT" ]; then
              COVERAGE_PERCENT="N/A"
            fi
            echo "**æ•´é«”è¦†è“‹ç‡ Overall Coverage**: $COVERAGE_PERCENT" >> test_report.md
            echo "" >> test_report.md
            
            # ç”Ÿæˆè©³ç´°è¦†è“‹ç‡å ±å‘Š
            pytest --cov=petsard --cov-report=term-missing --tb=no -q > coverage_detail.txt 2>&1 || true
            if grep -A 50 "Name.*Stmts.*Miss.*Cover.*Missing" coverage_detail.txt > coverage_table.txt 2>/dev/null; then
              echo "**è©³ç´°è¦†è“‹ç‡å ±å‘Š Detailed Coverage Report:**" >> test_report.md
              echo "" >> test_report.md
              echo "```" >> test_report.md
              cat coverage_table.txt >> test_report.md
              echo "```" >> test_report.md
              echo "" >> test_report.md
              
              # è¦†è“‹ç‡è§£è®€èªªæ˜
              echo "**ğŸ“– è¦†è“‹ç‡è§£è®€èªªæ˜ Coverage Explanation:**" >> test_report.md
              echo "- **Stmts**: ç¨‹å¼ç¢¼è¡Œæ•¸ (Total lines of code)" >> test_report.md
              echo "- **Miss**: æœªæ¸¬è©¦è¡Œæ•¸ (Lines not covered by tests)" >> test_report.md
              echo "- **Cover**: è¦†è“‹ç‡ç™¾åˆ†æ¯” (Coverage percentage)" >> test_report.md
              echo "- **Missing**: æœªè¦†è“‹çš„å…·é«”è¡Œè™Ÿ (Specific line numbers not covered)" >> test_report.md
              echo "" >> test_report.md
              
              # è¦†è“‹ç‡å“è³ªè©•ä¼°
              COVERAGE_NUM=$(echo $COVERAGE_PERCENT | sed 's/%//')
              if [ ! -z "$COVERAGE_NUM" ] && [ "$COVERAGE_NUM" != "N/A" ]; then
                if (( $(echo "$COVERAGE_NUM >= 90" | bc -l 2>/dev/null || echo 0) )); then
                  echo "ğŸ‰ **è¦†è“‹ç‡è©•ç´š**: å„ªç§€ (Excellent) - 90%+ è¦†è“‹ç‡" >> test_report.md
                elif (( $(echo "$COVERAGE_NUM >= 80" | bc -l 2>/dev/null || echo 0) )); then
                  echo "âœ… **è¦†è“‹ç‡è©•ç´š**: è‰¯å¥½ (Good) - 80-89% è¦†è“‹ç‡" >> test_report.md
                elif (( $(echo "$COVERAGE_NUM >= 70" | bc -l 2>/dev/null || echo 0) )); then
                  echo "âš ï¸ **è¦†è“‹ç‡è©•ç´š**: å°šå¯ (Fair) - 70-79% è¦†è“‹ç‡ï¼Œå»ºè­°æå‡" >> test_report.md
                else
                  echo "âŒ **è¦†è“‹ç‡è©•ç´š**: éœ€æ”¹é€² (Needs Improvement) - <70% è¦†è“‹ç‡ï¼Œå¼·çƒˆå»ºè­°å¢åŠ æ¸¬è©¦" >> test_report.md
                fi
              fi
            fi
          fi
          
          echo "" >> test_report.md
          echo "### ğŸ“ å®Œæ•´æ¸¬è©¦è¼¸å‡º Full Test Output" >> test_report.md
          echo "" >> test_report.md
          echo "<details>" >> test_report.md
          echo "<summary>é»æ“ŠæŸ¥çœ‹å®Œæ•´æ¸¬è©¦è¼¸å‡º Click to view full test output</summary>" >> test_report.md
          echo "" >> test_report.md
          echo "```" >> test_report.md
          cat test_output.txt >> test_report.md
          echo "```" >> test_report.md
          echo "</details>" >> test_report.md
          
      - name: ğŸ§ª Run Functional Tests
        id: functional-tests
        run: |
          echo "" >> test_report.md
          echo "### ğŸ”„ åŠŸèƒ½æ¸¬è©¦ Functional Tests" >> test_report.md
          echo "" >> test_report.md
          
          if pytest tests/test_petsard.py -v --disable-warnings > functional_output.txt 2>&1; then
            echo "functional_status=success" >> $GITHUB_OUTPUT
            echo "âœ… **åŠŸèƒ½æ¸¬è©¦é€šé** Functional tests passed" >> test_report.md
          else
            echo "functional_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ **åŠŸèƒ½æ¸¬è©¦å¤±æ•—** Functional tests failed" >> test_report.md
          fi
          
          echo "" >> test_report.md
          echo "```" >> test_report.md
          cat functional_output.txt >> test_report.md
          echo "```" >> test_report.md
          
      - name: ğŸ“Š Generate Test Summary
        run: |
          # åˆä½µ Ruff å ±å‘Šåˆ°ä¸»å ±å‘Š
          if [ -f ruff_report.md ]; then
            cat ruff_report.md >> test_report.md
            echo "" >> test_report.md
          fi
          
          echo "### ğŸ“Š æ¸¬è©¦æ‘˜è¦ Test Summary" >> test_report.md
          echo "" >> test_report.md
          
          # æª¢æŸ¥æ‰€æœ‰æ­¥é©Ÿçš„ç‹€æ…‹
          RUFF_STATUS="${{ steps.ruff-check.outputs.ruff_status }}"
          UNIT_STATUS="${{ steps.unit-tests.outputs.test_status }}"
          FUNC_STATUS="${{ steps.functional-tests.outputs.functional_status }}"
          
          if [[ "$RUFF_STATUS" == "success" && "$UNIT_STATUS" == "success" && "$FUNC_STATUS" == "success" ]]; then
            echo "ğŸ‰ **æ‰€æœ‰æª¢æŸ¥éƒ½é€šéï¼** All checks passed!" >> test_report.md
            echo "- âœ… ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥é€šé" >> test_report.md
            echo "- âœ… å–®å…ƒæ¸¬è©¦é€šé" >> test_report.md
            echo "- âœ… åŠŸèƒ½æ¸¬è©¦é€šé" >> test_report.md
            echo "test_overall=success" >> $GITHUB_ENV
          else
            echo "âš ï¸ **éƒ¨åˆ†æª¢æŸ¥å¤±æ•—** Some checks failed" >> test_report.md
            echo "- $([ "$RUFF_STATUS" == "success" ] && echo "âœ…" || echo "âŒ") ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥" >> test_report.md
            echo "- $([ "$UNIT_STATUS" == "success" ] && echo "âœ…" || echo "âŒ") å–®å…ƒæ¸¬è©¦" >> test_report.md
            echo "- $([ "$FUNC_STATUS" == "success" ] && echo "âœ…" || echo "âŒ") åŠŸèƒ½æ¸¬è©¦" >> test_report.md
            echo "test_overall=failed" >> $GITHUB_ENV
          fi
          
          echo "" >> test_report.md
          echo "---" >> test_report.md
          echo "*æ­¤å ±å‘Šç”±æ¸¬è©¦å¥—ä»¶è‡ªå‹•ç”Ÿæˆ | Auto-generated by Test Suite*" >> test_report.md
          
      - name: ğŸ’¬ Comment Test Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('test_report.md', 'utf8');
            
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰æ¸¬è©¦çµæœç•™è¨€
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              (comment.body.includes('ğŸ§ª æ¸¬è©¦çµæœ Test Results') || comment.body.includes('ğŸ§ª æ¸¬è©¦å¥—ä»¶å ±å‘Š Test Suite Report'))
            );
            
            const commentBody = `## ğŸ§ª æ¸¬è©¦å¥—ä»¶å ±å‘Š Test Suite Report\n\n${report}`;
            
            if (botComment) {
              // æ›´æ–°ç¾æœ‰ç•™è¨€
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // å‰µå»ºæ–°ç•™è¨€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
            
      - name: ğŸ“¤ Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-python-${{ matrix.python-version }}
          path: |
            test_output.txt
            functional_output.txt
            test_report.md
            coverage.xml
            failures.txt
            summary.txt
            coverage_detail.txt
            coverage_table.txt
            ruff_output.txt
            ruff_report.md
          retention-days: 7
          
      - name: â„¹ï¸ Test Status Summary
        if: always()
        run: |
          if [[ "$test_overall" == "success" ]]; then
            echo "::notice::ğŸ‰ æ‰€æœ‰æª¢æŸ¥é€šéï¼All checks passed for Python ${{ matrix.python-version }} (Code Quality + Tests)"
          else
            echo "::warning::âš ï¸ éƒ¨åˆ†æª¢æŸ¥å¤±æ•—ï¼Œä½†ä¸æœƒé˜»æ­¢åˆä½µã€‚Some checks failed for Python ${{ matrix.python-version }} (Code Quality + Tests), but merge is not blocked."
          fi