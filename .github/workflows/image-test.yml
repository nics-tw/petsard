name: Image Testing

on:
  workflow_run:
    workflows: ["Image Building and Publishing"]
    types:
      - completed
    branches:
      - main
      - dev
  push:
    tags:
      - "v*"
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test-image:
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨æˆåŠŸå»ºç½®ä¸”ä¸æ˜¯ PR æ™‚æ‰æ¸¬è©¦
    if: |
      github.event_name != 'pull_request' && (
        github.event_name == 'push' ||
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      )
    strategy:
      matrix:
        variant:
          - name: "standard"
            suffix: ""
          - name: "jupyter"
            suffix: "-jupyter"

    steps:
      - name: ðŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§ª Test Docker image (${{ matrix.variant.name }})
        run: |
          # å–å¾—æ˜ åƒæ¨™ç±¤
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          elif [[ $GITHUB_REF == refs/heads/main ]]; then
            TAG=latest
          else
            TAG=${GITHUB_REF#refs/heads/}
          fi

          IMAGE_URL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}${{ matrix.variant.suffix }}"
          echo "Testing image: $IMAGE_URL"

          # æ¸¬è©¦æ˜ åƒæ˜¯å¦å¯ä»¥æ­£å¸¸é‹è¡Œ
          docker run --rm $IMAGE_URL python -c "
          import petsard
          import importlib.metadata
          import os
          print('âœ… PETsARD å¥—ä»¶è¼‰å…¥æˆåŠŸ')

          # æª¢æŸ¥è®Šé«”é¡žåž‹
          include_jupyter = os.getenv('INCLUDE_JUPYTER', 'false').lower() == 'true'
          variant = 'jupyter' if include_jupyter else 'standard'
          print(f'ðŸ“¦ æ˜ åƒè®Šé«”: {variant}')

          # ä½¿ç”¨ importlib.metadata ç²å–ç‰ˆæœ¬è™Ÿï¼ˆé…åˆ semantic releaseï¼‰
          try:
              version = importlib.metadata.version('petsard')
              print(f'ðŸ“¦ ç‰ˆæœ¬: {version}')
          except Exception as e:
              print(f'âš ï¸  ç‰ˆæœ¬ç²å–å¤±æ•—: {e}')

          # æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
          from petsard.executor import Executor
          print('âœ… Executor é¡žåˆ¥è¼‰å…¥æˆåŠŸ')

          # æ¸¬è©¦æ¨¡çµ„åŒ¯å…¥
          from petsard import loader, constrainer, synthesizer, evaluator
          print('âœ… æ‰€æœ‰ä¸»è¦æ¨¡çµ„è¼‰å…¥æˆåŠŸ')

          # æ¢ä»¶æ€§æ¸¬è©¦ Jupyterï¼ˆåªæœ‰åœ¨ jupyter è®Šé«”æ™‚ï¼‰
          if include_jupyter:
              try:
                  import jupyterlab
                  print('âœ… Jupyter Lab è¼‰å…¥æˆåŠŸ')
              except ImportError:
                  print('âŒ Jupyter Lab è¼‰å…¥å¤±æ•—')
                  exit(1)
          else:
              print('âœ… Standard è®Šé«” - å·²è·³éŽ Jupyter æ¸¬è©¦')
              try:
                  import jupyterlab
                  print('âŒ é€™æ‡‰è©²æ˜¯ Standard è®Šé«”ï¼Œä½†åŒ…å«äº† Jupyter')
                  exit(1)
              except ImportError:
                  print('âœ… ç¢ºèªæ²’æœ‰ Jupyter ä¾è³´')

          # æ¸¬è©¦å¥åº·æª¢æŸ¥åŠŸèƒ½
          try:
              health_version = importlib.metadata.version('petsard')
              print(f'ðŸ¥ å¥åº·æª¢æŸ¥é€šéŽ - PETsARD v{health_version} ({variant} è®Šé«”)')
          except Exception as e:
              print(f'âŒ å¥åº·æª¢æŸ¥å¤±æ•—: {e}')
              exit(1)

          print(f'ðŸŽ‰ Docker æ˜ åƒæ¸¬è©¦é€šéŽï¼({variant} è®Šé«”)')
          "

      - name: ðŸ“Š Display image information
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          elif [[ $GITHUB_REF == refs/heads/main ]]; then
            TAG=latest
          else
            TAG=${GITHUB_REF#refs/heads/}
          fi

          IMAGE_URL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}${{ matrix.variant.suffix }}"
          echo "## ðŸ“¦ Docker æ˜ åƒè³‡è¨Š (${{ matrix.variant.name }} è®Šé«”)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ˜ åƒä½ç½®:** \`$IMAGE_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä½¿ç”¨æ–¹å¼:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# æ‹‰å–æ˜ åƒ" >> $GITHUB_STEP_SUMMARY
          echo "docker pull $IMAGE_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ matrix.variant.name }}" == "jupyter" ]]; then
            echo "# é‹è¡Œ Jupyter Lab" >> $GITHUB_STEP_SUMMARY
            echo "docker run -it -p 8888:8888 -v \$(pwd)/data:/app/data -v \$(pwd)/notebooks:/app/notebooks $IMAGE_URL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# é‹è¡Œ Python REPL" >> $GITHUB_STEP_SUMMARY
            echo "docker run -it --entrypoint /opt/venv/bin/python3 $IMAGE_URL" >> $GITHUB_STEP_SUMMARY
          else
            echo "# é‹è¡Œ Python REPLï¼ˆstandard ç‰ˆæœ¬ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "docker run -it --entrypoint /opt/venv/bin/python3 $IMAGE_URL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# é‹è¡Œç¯„ä¾‹ï¼ˆæŽ›è¼‰è³‡æ–™ç›®éŒ„ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "docker run -it -v \$(pwd):/app/data --entrypoint /opt/venv/bin/python3 $IMAGE_URL" >> $GITHUB_STEP_SUMMARY
          fi

          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
