name: ðŸ³ Build and Publish Docker Image

on:
  # ç•¶ semantic release workflow å®Œæˆæ™‚è§¸ç™¼
  workflow_run:
    workflows: ["Semantic Release"]
    types:
      - completed
    branches:
      - main
      - dev
  # ç•¶æœ‰æ–°çš„ç‰ˆæœ¬æ¨™ç±¤æ™‚è§¸ç™¼
  push:
    tags:
      - 'v*'
  # PR æ™‚ä»ç„¶å»ºç½®ä½†ä¸æŽ¨é€
  pull_request:
    branches:
      - main
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨ semantic release æˆåŠŸæˆ–è€…æ˜¯æ¨™ç±¤æŽ¨é€æ™‚æ‰åŸ·è¡Œ
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: read
      packages: write
      # é€™æ˜¯ç”¨æ–¼ attestations
      id-token: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # å°æ–¼ workflow_run äº‹ä»¶ï¼Œæˆ‘å€‘éœ€è¦ checkout åˆ°æœ€æ–°çš„ commit
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref }}
          fetch-depth: 0

      - name: ðŸ” Debug - Check current version (after semantic release)
        if: github.event_name == 'workflow_run'
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Head branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Current ref: ${{ github.ref }}"
          echo "Current SHA: ${{ github.sha }}"
          
          # æª¢æŸ¥ pyproject.toml ä¸­çš„ç‰ˆæœ¬è™Ÿ
          if [ -f "pyproject.toml" ]; then
            echo "=== pyproject.toml version ==="
            grep -E "^version\s*=" pyproject.toml || echo "Version not found in pyproject.toml"
          fi
          
          # æª¢æŸ¥æœ€æ–°çš„ Git æ¨™ç±¤
          echo "=== Latest Git tags ==="
          git tag --sort=-version:refname | head -5 || echo "No tags found"

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # set latest tag for default branch
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ³ Build and push Docker image
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ” Generate artifact attestation
        if: github.event_name != 'pull_request'
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME}}
          subject-digest: ${{ steps.build-and-push.outputs.digest }}
          push-to-registry: true

  test-image:
    needs: build-and-push
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨æˆåŠŸå»ºç½®ä¸”ä¸æ˜¯ PR æ™‚æ‰æ¸¬è©¦
    if: |
      github.event_name != 'pull_request' && (
        github.event_name == 'push' ||
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      )
    
    steps:
      - name: ðŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§ª Test Docker image
        run: |
          # å–å¾—æ˜ åƒæ¨™ç±¤
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          elif [[ $GITHUB_REF == refs/heads/main ]]; then
            TAG=latest
          else
            TAG=${GITHUB_REF#refs/heads/}
          fi
          
          IMAGE_URL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"
          echo "Testing image: $IMAGE_URL"
          
          # æ¸¬è©¦æ˜ åƒæ˜¯å¦å¯ä»¥æ­£å¸¸é‹è¡Œ
          docker run --rm $IMAGE_URL python -c "
          import petsard
          import importlib.metadata
          print('âœ… PETsARD å¥—ä»¶è¼‰å…¥æˆåŠŸ')
          
          # ä½¿ç”¨ importlib.metadata ç²å–ç‰ˆæœ¬è™Ÿï¼ˆé…åˆ semantic releaseï¼‰
          try:
              version = importlib.metadata.version('petsard')
              print(f'ðŸ“¦ ç‰ˆæœ¬: {version}')
          except Exception as e:
              print(f'âš ï¸  ç‰ˆæœ¬ç²å–å¤±æ•—: {e}')
          
          # æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
          from petsard.executor import Executor
          print('âœ… Executor é¡žåˆ¥è¼‰å…¥æˆåŠŸ')
          
          # æ¸¬è©¦æ¨¡çµ„åŒ¯å…¥
          from petsard import loader, constrainer, synthesizer, evaluator
          print('âœ… æ‰€æœ‰ä¸»è¦æ¨¡çµ„è¼‰å…¥æˆåŠŸ')
          
          # æ¸¬è©¦å¥åº·æª¢æŸ¥åŠŸèƒ½
          try:
              health_version = importlib.metadata.version('petsard')
              print(f'ðŸ¥ å¥åº·æª¢æŸ¥é€šéŽ - PETsARD v{health_version}')
          except Exception as e:
              print(f'âŒ å¥åº·æª¢æŸ¥å¤±æ•—: {e}')
              exit(1)
          
          print('ðŸŽ‰ Docker æ˜ åƒæ¸¬è©¦é€šéŽï¼')
          "

      - name: ðŸ“Š Display image information
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          elif [[ $GITHUB_REF == refs/heads/main ]]; then
            TAG=latest
          else
            TAG=${GITHUB_REF#refs/heads/}
          fi
          
          IMAGE_URL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"
          echo "## ðŸ“¦ Docker æ˜ åƒè³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ˜ åƒä½ç½®:** \`$IMAGE_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä½¿ç”¨æ–¹å¼:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# æ‹‰å–æ˜ åƒ" >> $GITHUB_STEP_SUMMARY
          echo "docker pull $IMAGE_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# é‹è¡Œå®¹å™¨" >> $GITHUB_STEP_SUMMARY
          echo "docker run -it --rm $IMAGE_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# é‹è¡Œç¯„ä¾‹" >> $GITHUB_STEP_SUMMARY
          echo "docker run -it --rm -v \$(pwd):/workspace $IMAGE_URL bash" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY