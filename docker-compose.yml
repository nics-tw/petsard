version: '3.8'

services:
  petsard:
    build:
      context: .
      dockerfile: Dockerfile
    image: petsard:latest
    container_name: petsard-dev
    volumes:
      # æŽ›è¼‰ç•¶å‰ç›®éŒ„åˆ°å®¹å™¨ä¸­ï¼Œæ–¹ä¾¿é–‹ç™¼
      - .:/workspace
      # æŽ›è¼‰è³‡æ–™ç›®éŒ„
      - ./demo:/app/demo
      # æŽ›è¼‰è¼¸å‡ºç›®éŒ„
      - ./output:/app/output
    working_dir: /workspace
    environment:
      - PYTHONPATH=/workspace:/app
      - PYTHONUNBUFFERED=1
    # ä¿æŒå®¹å™¨é‹è¡Œ
    command: tail -f /dev/null
    # æˆ–è€…ç›´æŽ¥é€²å…¥ bash
    # command: bash

  # ç”¨æ–¼é‹è¡Œç¯„ä¾‹çš„æœå‹™
  petsard-demo:
    build:
      context: .
      dockerfile: Dockerfile
    image: petsard:latest
    container_name: petsard-demo
    volumes:
      - ./demo:/app/demo
      - ./output:/app/output
    working_dir: /app/demo
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    # é‹è¡Œç‰¹å®šçš„ç¯„ä¾‹
    command: >
      python -c "
      import sys;
      sys.path.append('/app');
      from petsard.executor import Executor;
      print('ðŸš€ PETsARD Demo Container Ready!');
      print('Available demos in /app/demo/');
      import os;
      for root, dirs, files in os.walk('/app/demo'):
          for file in files:
              if file.endswith('.yaml'):
                  print(f'  - {os.path.join(root, file)}')
      "

  # ç”¨æ–¼ Jupyter Notebook çš„æœå‹™
  petsard-jupyter:
    build:
      context: .
      dockerfile: Dockerfile
    image: petsard:latest
    container_name: petsard-jupyter
    ports:
      - "8888:8888"
    volumes:
      - .:/workspace
      - ./demo:/app/demo
      - ./notebooks:/app/notebooks
    working_dir: /workspace
    environment:
      - PYTHONPATH=/workspace:/app
      - PYTHONUNBUFFERED=1
    command: >
      bash -c "
      pip install jupyter notebook &&
      jupyter notebook --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='' --NotebookApp.password=''
      "

networks:
  default:
    name: petsard-network